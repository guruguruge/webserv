##  II. 一般的なルール (General rules)

* あなたのプログラムは、いかなる状況（メモリ不足など）でもクラッシュしたり、予期せず終了したりしてはなりません。
    * これが発生した場合、プロジェクトは機能していないとみなされ、評価は **0点** となります。
* ソースファイルをコンパイルするための`Makefile`を提出する必要があります。不要な再リンクを行ってはなりません。
* `Makefile`には少なくとも `$(NAME)`, `all`, `clean`, `fclean`, `re` のルールを含める必要があります。
* コードは `c++` と `-Wall -Wextra -Werror` のフラグでコンパイルしてください。
* コードは **C++ 98 標準**に準拠し、`-std=c++98` フラグを追加してもコンパイルできる必要があります。
* C++の機能を可能な限り活用してください（例： `<string.h>` よりも `<cstring>` を選ぶ）。C言語の関数を使用することは許可されますが、可能な限りC++版を優先してください。
* **外部ライブラリおよびBoostライブラリは一切禁止**です。

---

## IV. 必須パート (Mandatory part)

| 項目 | 詳細 |
| :--- | :--- |
| **プログラム名** | `webserv` |
| **提出ファイル** | `Makefile`, `*.{h, hpp}`, `*.cpp`, `*.tpp`, `*.ipp`, 設定ファイル |
| **Makefileルール** | `NAME`, `all`, `clean`, `fclean`, `re` |
| **引数** | `[設定ファイル]` |
| **説明** | C++ 98 で実装されたHTTPサーバー |
| **Libft許可** | n/a |

**許可される外部関数:**
すべての機能は **C++ 98** で実装する必要があります。以下の関数のみ使用が許可されます。
`execve`, `pipe`, `strerror`, `gai_strerror`, `errno`, `dup`, `dup2`, `fork`, `socketpair`, `htons`, `htonl`, `ntohs`, `ntohl`, `select`, `poll`, `epoll` (`epoll_create`, `epoll_ctl`, `epoll_wait`), `kqueue` (`kqueue`, `kevent`), `socket`, `accept`, `listen`, `send`, `recv`, `chdir`, `bind`, `connect`, `getaddrinfo`, `freeaddrinfo`, `setsockopt`, `getsockname`, `getprotobyname`, `fcntl`, `close`, `read`, `write`, `waitpid`, `kill`, `signal`, `access`, `stat`, `open`, `opendir`, `readdir`, `closedir`

**実行方法:**
`./webserv [設定ファイル]`

> `poll()` が記載されていますが、`select()`, `kqueue()`, `epoll()` といった同等の関数を使用しても構いません。

---

### IV.1 要件 (Requirements)

* プログラムは、コマンドライン引数として提供されるか、デフォルトパスにある**設定ファイル**を使用しなければなりません。
* 他のウェブサーバーを `execve` してはなりません。
* サーバーは常に**ノンブロッキング**でなければならず、必要に応じてクライアントの切断を適切に処理しなければなりません。
* サーバーはノンブロッキングであり、クライアントとサーバー間のすべてのI/O操作（`listen`を含む）に対して **1つの `poll()`**（または同等のもの）のみを使用しなければなりません。
* `poll()`（または同等のもの）は、**読み取りと書き込みの両方を同時に**監視しなければなりません。
* `poll()`（または同等のもの）を経由せずに `read` や `write` 操作を決して行ってはなりません。
* `read` または `write` 操作の実行後に `errno` の値を確認してサーバーの動作を調整することは**厳しく禁止**します。
* 通常のディスクファイルに対して `poll()`（または同等の関数）を使用する必要はありません。
    > **重要:** データを待つ可能性のあるI/O（ソケット、パイプ/FIFOなど）は、ノンブロッキングであり、単一の `poll()`（または同等のもの）によって駆動されなければなりません。準備完了の確認なしにこれらのディスクリプタで `read/recv` または `write/send` を呼び出すと、評価は **0点** となります。通常のディスクファイルは免除されます。
* `poll()` または同等の呼び出しを使用する場合、関連するすべてのマクロやヘルパー関数（例： `select()` の `FD_SET`）を使用できます。
* サーバーへのリクエストが無限にハングしてはなりません。
* サーバーは、選択した標準的なウェブブラウザと互換性がなければなりません。
* NGINXをヘッダーや応答の動作比較に使用してもよいです（HTTPのバージョン間の違いに注意）。
* HTTP応答のステータスコードは正確でなければなりません。
* サーバーには、提供されていない場合に備えて**デフォルトのエラーページ**がなければなりません。
* `fork` は **CGI**（PHP、Pythonなど）以外の目的で使用してはなりません。
* 完全に**静的なウェブサイト**を提供できなければなりません。
* クライアントはファイルを**アップロード**できなければなりません。
* 少なくとも **GET, POST, DELETE** メソッドをサポートしなければなりません。
* サーバーにストレステストを行い、常時利用可能であることを確認してください。
* サーバーは、異なるコンテンツを提供するために**複数のポート**でリッスンできなければなりません（設定ファイル参照）。

---

### IV.2 MacOS のみ (For MacOS only)

* macOSは `write()` の扱いが他のUnix系OSと異なるため、`fcntl()` の使用が許可されます。
* 他のUnix OSと同様の動作を実現するために、ファイルディスクリプタをノンブロッキングモードで使用しなければなりません。
* ただし、`fcntl()` は以下のフラグでのみ使用が許可されます：
    * `F_SETFL`
    * `O_NONBLOCK`
    * `FD_CLOEXEC`
* これ以外のフラグの使用は禁止します。

---

### IV.3 設定ファイル (Configuration file)

NGINX設定ファイルの `server` セクションを参考にすることができます。
設定ファイルでは、以下の設定が可能である必要があります：

* サーバーがリッスンするすべての `インターフェース:ポート` のペアを定義する（複数のウェブサイトを提供する）。
* デフォルトのエラーページを設定する。
* クライアントリクエストボディの**最大許容サイズ**を設定する。
* 特定のURL/ルートに対するルールや設定を指定する（正規表現は不要）。以下の項目を含みます：
    * そのルートで許可されるHTTPメソッドのリスト。
    * HTTPリダイレクション。
    * リクエストされたファイルを探すべきディレクトリ（例：URL `/kapouet` が `/tmp/www` にルート設定されている場合、`/kapouet/pouic/toto/pouet` は `/tmp/www/pouic/toto/pouet` を探す）。
    * ディレクトリリスティングの有効化または無効化。
    * リクエストされたリソースがディレクトリの場合に提供するデフォルトファイル。
    * クライアントからサーバーへのファイルアップロードが許可されていること、およびその保存場所。
    * ファイル拡張子に基づく **CGI の実行**（例： `.php`）。
        * **CGIに関する注意点:**
            * ウェブサーバーとCGI間の通信に関わる**環境変数**を注意深く確認してください。クライアントから提供された完全なリクエストと引数がCGIで利用可能でなければなりません。
            * チャンク化されたリクエストの場合、サーバーはそれを**非チャンク化**する必要があります。CGIはボディの終わりとしてEOFを期待します。
            * CGIの出力についても同様です。CGIから `content_length` が返されない場合、EOFが返却データの終わりを示します。
            * CGIは、相対パスでのファイルアクセスのために正しいディレクトリで実行されるべきです。
            * サーバーは**少なくとも1つのCGI**（php-CGI, Pythonなど）をサポートしなければなりません。

* 評価中にすべての機能が動作することをテスト・実証するために、設定ファイルとデフォルトファイルを提供しなければなりません。